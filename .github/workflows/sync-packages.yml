name: Sync QNAP Packages

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤© UTC 23:00 (åŒ—äº¬æ—¶é—´ 7:00) è¿è¡Œ
  schedule:
    - cron: '0 23 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_download:
        description: 'å¼ºåˆ¶ä¸‹è½½æ‰€æœ‰è½¯ä»¶ï¼ˆå¿½ç•¥å˜åŒ–æ£€æµ‹ï¼‰'
        required: false
        type: boolean
        default: false
      download_only:
        description: 'ä»…ä¸‹è½½ï¼Œä¸ä¸Šä¼ '
        required: false
        type: boolean
        default: false
      upload_only:
        description: 'ä»…ä¸Šä¼ å·²ä¸‹è½½çš„æ–‡ä»¶'
        required: false
        type: boolean
        default: false

# å–æ¶ˆæ­£åœ¨è¿è¡Œçš„æ—§å·¥ä½œæµ
concurrency:
  group: sync-packages
  cancel-in-progress: true

jobs:
  sync:
    name: åŒæ­¥ QNAP è½¯ä»¶åŒ…
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 å°æ—¶è¶…æ—¶

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Bun çŽ¯å¢ƒ
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£…ä¾èµ–
        run: bun install --frozen-lockfile

      - name: å¯ç”¨ BBR åŠ é€Ÿ
        run: |
          echo "æ­£åœ¨å¯ç”¨ BBR TCP æ‹¥å¡žæŽ§åˆ¶ç®—æ³•..."

          # æ£€æŸ¥å½“å‰å†…æ ¸ç‰ˆæœ¬
          kernel_version=$(uname -r)
          echo "å½“å‰å†…æ ¸ç‰ˆæœ¬: $kernel_version"

          # æ£€æŸ¥ BBR æ¨¡å—æ˜¯å¦å¯ç”¨
          if [ -f /proc/sys/net/ipv4/tcp_available_congestion_control ]; then
            echo "å¯ç”¨çš„æ‹¥å¡žæŽ§åˆ¶ç®—æ³•:"
            cat /proc/sys/net/ipv4/tcp_available_congestion_control
          fi

          # å¯ç”¨ BBR
          sudo sysctl -w net.core.default_qdisc=fq
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr

          # éªŒè¯é…ç½®
          echo ""
          echo "âœ“ BBR é…ç½®å®Œæˆ"
          echo "  é˜Ÿåˆ—è°ƒåº¦ç®—æ³•: $(cat /proc/sys/net/core/default_qdisc)"
          echo "  æ‹¥å¡žæŽ§åˆ¶ç®—æ³•: $(cat /proc/sys/net/ipv4/tcp_congestion_control)"

          # é¢å¤–çš„ç½‘ç»œä¼˜åŒ–å‚æ•°
          sudo sysctl -w net.ipv4.tcp_notsent_lowat=16384
          sudo sysctl -w net.ipv4.tcp_slow_start_after_idle=0

          echo "âœ“ ç½‘ç»œä¼˜åŒ–å‚æ•°å·²åº”ç”¨"

      - name: é…ç½®çŽ¯å¢ƒå˜é‡
        run: |
          cat > .env << EOF
          # QNAP ä¸‹è½½æºé…ç½®
          QNAP_DOWNLOAD_URL=${{ secrets.QNAP_DOWNLOAD_URL }}
          QNAP_USERNAME=${{ secrets.QNAP_USERNAME }}
          QNAP_PASSWORD=${{ secrets.QNAP_PASSWORD }}

          # CTFile é…ç½®
          CTFILE_SESSION=${{ secrets.CTFILE_SESSION }}
          CTFILE_FOLDER_ID=${{ secrets.CTFILE_FOLDER_ID }}
          CTFILE_USER=${{ secrets.CTFILE_USER }}
          CTFILE_PASSWORD=${{ secrets.CTFILE_PASSWORD }}

          # WebDAV é…ç½® (å¯é€‰ï¼Œä½œä¸ºä¸Šä¼ å¤±è´¥çš„å¤‡ç”¨æ–¹æ¡ˆ)
          WEBDAV_URL=${{ secrets.WEBDAV_URL }}
          WEBDAV_USERNAME=${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD=${{ secrets.WEBDAV_PASSWORD }}
          WEBDAV_ROOT_PATH=/qnaporg-github

          # ä¸Šä¼ é…ç½®
          UPLOAD_CONCURRENCY=2
          MAX_UPLOAD_FILE_SIZE=1073741824
          EOF

          echo "âœ“ çŽ¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

      - name: åˆ›å»ºå¿…è¦çš„ç›®å½•
        run: |
          mkdir -p downloads
          mkdir -p config

      - name: æ¢å¤ä¹‹å‰çš„ apps.jsonï¼ˆç”¨äºŽå¢žé‡æ£€æµ‹ï¼‰
        if: ${{ !inputs.upload_only }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: config-apps-json
          path: config/

      - name: æ¢å¤ä¸Šä¼ è¿›åº¦å’Œå…ƒæ•°æ®
        if: ${{ !inputs.upload_only }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: metadata
          path: downloads/

      - name: æ£€æŸ¥ apps.json æ˜¯å¦æ¢å¤æˆåŠŸ
        if: ${{ !inputs.upload_only }}
        run: |
          if [ -f config/apps.json ]; then
            app_count=$(jq '.plugins.item | length' config/apps.json)
            echo "âœ“ æˆåŠŸæ¢å¤ä¹‹å‰çš„ apps.jsonï¼ˆåŒ…å« $app_count ä¸ªè½¯ä»¶åŒ…ï¼‰"
            echo "   å°†è¿›è¡Œå¢žé‡æ›´æ–°æ£€æµ‹"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ°ä¹‹å‰çš„ apps.json"
            echo "   åŽŸå› å¯èƒ½æ˜¯ï¼š"
            echo "   - é¦–æ¬¡è¿è¡Œæ­¤å·¥ä½œæµ"
            echo "   - Artifact å·²è¿‡æœŸï¼ˆä¿ç•™æœŸ 90 å¤©ï¼‰"
            echo "   - Artifact å·²è¢«æ‰‹åŠ¨æ¸…ç†"
            echo "   æœ¬æ¬¡å°†èŽ·å–å®Œæ•´è½¯ä»¶åŒ…åˆ—è¡¨å¹¶æ‰§è¡Œå®Œæ•´ä¸‹è½½"
          fi

      - name: èŽ·å–å¹¶æ£€æŸ¥è½¯ä»¶åŒ…æ›´æ–°
        if: ${{ !inputs.upload_only }}
        id: check_updates
        run: |
          echo "ðŸ“¥ èŽ·å–æœ€æ–°çš„ QNAP è½¯ä»¶åŒ…åˆ—è¡¨..."

          # ä½¿ç”¨ fetch å‘½ä»¤èŽ·å–æœ€æ–°åˆ—è¡¨å¹¶æ£€æµ‹å·®å¼‚
          bun run fetch

          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº† update-apps.json
          if [ -f config/update-apps.json ]; then
            update_count=$(jq '.plugins.item | length' config/update-apps.json)
            echo "ðŸ“‹ æ£€æµ‹åˆ° $update_count ä¸ªæ–°å¢žæˆ–æ›´æ–°çš„è½¯ä»¶åŒ…"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "update_count=$update_count" >> $GITHUB_OUTPUT

            # æ˜¾ç¤ºæ›´æ–°åˆ—è¡¨
            echo ""
            echo "æ›´æ–°åˆ—è¡¨ï¼š"
            jq -r '.plugins.item[] | "  â€¢ \(.name) v\(.version)"' config/update-apps.json
          else
            echo "âœ“ è½¯ä»¶åŒ…åˆ—è¡¨æ— æ›´æ–°"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "update_count=0" >> $GITHUB_OUTPUT
          fi

          # ä¿å­˜ apps.json çš„æ€»æ•°
          if [ -f config/apps.json ]; then
            total_count=$(jq '.plugins.item | length' config/apps.json)
            echo "total_count=$total_count" >> $GITHUB_OUTPUT
            echo "ðŸ“Š è½¯ä»¶åŒ…æ€»æ•°: $total_count"
          fi

      - name: æ£€æŸ¥ CTFile ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶
        if: ${{ !inputs.upload_only && steps.check_updates.outputs.has_updates == 'true' && !inputs.force_download }}
        id: check_existing
        run: |
          echo "ðŸ” æ£€æŸ¥ CTFile ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸‹è½½..."
          echo ""

          # è¿è¡Œæ£€æŸ¥è„šæœ¬
          bun run check-existing

          # ç»Ÿè®¡æ¸…ç†åŽçš„æ•°é‡
          if [ -f config/update-apps.json ]; then
            remaining_count=$(jq '.plugins.item | length' config/update-apps.json)
            removed_count=$((${{ steps.check_updates.outputs.update_count }} - remaining_count))

            echo ""
            echo "ðŸ“Š æ£€æŸ¥ç»“æžœï¼š"
            echo "  åŽŸè®¡åˆ’ä¸‹è½½: ${{ steps.check_updates.outputs.update_count }} ä¸ª"
            echo "  å·²å­˜åœ¨è·³è¿‡: $removed_count ä¸ª"
            echo "  å®žé™…éœ€è¦ä¸‹è½½: $remaining_count ä¸ª"
            echo ""

            echo "remaining_count=$remaining_count" >> $GITHUB_OUTPUT
            echo "removed_count=$removed_count" >> $GITHUB_OUTPUT

            # å¦‚æžœæ‰€æœ‰æ–‡ä»¶éƒ½å·²å­˜åœ¨ï¼Œæ ‡è®°ä¸ºæ— éœ€ä¸‹è½½
            if [ "$remaining_count" -eq 0 ]; then
              echo "âœ“ æ‰€æœ‰è½¯ä»¶åŒ…éƒ½å·²å­˜åœ¨äºŽ CTFileï¼Œæ— éœ€ä¸‹è½½"
              echo "needs_download=false" >> $GITHUB_OUTPUT
            else
              echo "needs_download=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "needs_download=false" >> $GITHUB_OUTPUT
          fi

      - name: å¢žé‡ä¸‹è½½æ›´æ–°çš„è½¯ä»¶åŒ…
        if: ${{ !inputs.upload_only && (steps.check_updates.outputs.has_updates == 'true' || inputs.force_download) }}
        run: |
          if [ "${{ inputs.force_download }}" = "true" ]; then
            echo "ðŸ”„ å¼ºåˆ¶ä¸‹è½½æ¨¡å¼ï¼šä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…"
            bun run download:all
          else
            echo "âš¡ å¢žé‡ä¸‹è½½æ¨¡å¼ï¼šåªä¸‹è½½ ${{ steps.check_updates.outputs.update_count }} ä¸ªæ›´æ–°çš„è½¯ä»¶åŒ…"
            bun run download:update
          fi

          echo ""
          echo "ðŸ“Š ä¸‹è½½ç»Ÿè®¡ï¼š"
          if [ -f downloads/metadata.json ]; then
            echo "  å…ƒæ•°æ®æ–‡ä»¶: âœ“"
            jq -r '.[] | "  - \(.productName) \(.version) [\(.architecture)]"' downloads/metadata.json | head -20
            total=$(jq '. | length' downloads/metadata.json)
            echo "  æ€»è®¡: $total ä¸ªè½¯ä»¶åŒ…"
          else
            echo "  âš  æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
          fi

          echo ""
          echo "ðŸ’¾ ä¸‹è½½æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh downloads/*.qpkg 2>/dev/null | awk '{print "  " $9 " (" $5 ")"}' || echo "  æœªæ‰¾åˆ° QPKG æ–‡ä»¶"

      - name: è·³è¿‡ä¸‹è½½ï¼ˆæ— æ›´æ–°ï¼‰
        if: ${{ !inputs.upload_only && steps.check_updates.outputs.has_updates == 'false' && !inputs.force_download }}
        run: |
          echo "âœ“ è½¯ä»¶åŒ…åˆ—è¡¨æ— æ›´æ–°ï¼Œè·³è¿‡ä¸‹è½½"
          echo "ðŸ“Š å½“å‰è½¯ä»¶åŒ…æ€»æ•°: ${{ steps.check_updates.outputs.total_count }}"
          echo ""
          echo "å¦‚éœ€å¼ºåˆ¶ä¸‹è½½ï¼Œè¯·ä½¿ç”¨ force_download å‚æ•°æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ"

      - name: æ¢å¤ä¸Šä¼ è¿›åº¦å’Œå…ƒæ•°æ®ï¼ˆç”¨äºŽé‡æ–°ä¸‹è½½å¤±è´¥çš„ä¸Šä¼ ï¼‰
        if: ${{ !inputs.download_only && !inputs.upload_only }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: metadata
          path: downloads/

      - name: æ£€æŸ¥å¹¶é‡æ–°ä¸‹è½½æœªä¸Šä¼ çš„æ–‡ä»¶
        if: ${{ !inputs.download_only && !inputs.upload_only && steps.check_updates.outputs.has_updates == 'false' }}
        run: |
          echo "ðŸ” æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½ä½†æœªæˆåŠŸä¸Šä¼ çš„æ–‡ä»¶..."

          # å¦‚æžœæ²¡æœ‰ metadata.jsonï¼Œè¯´æ˜Žæ²¡æœ‰ä¹‹å‰çš„ä¸‹è½½è®°å½•
          if [ ! -f downloads/metadata.json ]; then
            echo "â„¹ æœªæ‰¾åˆ°ä¹‹å‰çš„ metadata.jsonï¼Œæ— éœ€é‡æ–°ä¸‹è½½"
            exit 0
          fi

          # æ£€æŸ¥downloadsç›®å½•æ˜¯å¦æœ‰å®žé™…æ–‡ä»¶
          qpkg_count=$(ls -1 downloads/*.qpkg 2>/dev/null | wc -l || echo "0")

          if [ "$qpkg_count" -eq 0 ]; then
            echo "âš  å‘çŽ° metadata.json ä½† downloads ç›®å½•ä¸ºç©ºï¼Œéœ€è¦é‡æ–°ä¸‹è½½"
            metadata_count=$(jq '. | length' downloads/metadata.json)
            echo "  å°†é‡æ–°ä¸‹è½½ $metadata_count ä¸ªæ–‡ä»¶"

            # æ¸…ç©º metadata.json ä»¥å¼ºåˆ¶é‡æ–°ä¸‹è½½
            rm -f downloads/metadata.json downloads/metadata-uploaded.json downloads/upload-progress.json

            # é‡æ–°ä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…ï¼ˆå·²å­˜åœ¨çš„ä¼šè¢«è·³è¿‡ï¼‰
            echo ""
            echo "ðŸ”„ å¼€å§‹é‡æ–°ä¸‹è½½..."
            bun run download:all

            echo ""
            echo "ðŸ“Š é‡æ–°ä¸‹è½½ç»Ÿè®¡ï¼š"
            if [ -f downloads/metadata.json ]; then
              total=$(jq '. | length' downloads/metadata.json)
              echo "  æ€»è®¡: $total ä¸ªè½¯ä»¶åŒ…"
            fi
          else
            echo "âœ“ downloads ç›®å½•åŒ…å« $qpkg_count ä¸ªæ–‡ä»¶ï¼Œæ— éœ€é‡æ–°ä¸‹è½½"
          fi

      - name: ä¸Šä¼ åˆ° CTFile
        if: ${{ !inputs.download_only }}
        run: |
          echo "å¼€å§‹ä¸Šä¼ åˆ° CTFile..."

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ 
          if ! ls downloads/*.qpkg 1> /dev/null 2>&1; then
            echo "âš  æ²¡æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ "
            exit 0
          fi

          # æ‰§è¡Œä¸Šä¼ 
          bun run src/upload.ts

          echo ""
          echo "ðŸ“Š ä¸Šä¼ ç»“æžœï¼š"
          if [ -f downloads/metadata-uploaded.json ]; then
            echo "  ä¸Šä¼ å…ƒæ•°æ®: âœ“"

            # ç»Ÿè®¡ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶
            success=$(jq '[.[] | select(.ctfileUrl != null)] | length' downloads/metadata-uploaded.json)
            total=$(jq '. | length' downloads/metadata-uploaded.json)
            echo "  æˆåŠŸ: $success/$total"
          fi

          if [ -f downloads/PACKAGES.md ]; then
            echo "  README æ–‡ä»¶: âœ“"
            wc -l downloads/PACKAGES.md | awk '{print "    " $1 " è¡Œ"}'
          fi

      - name: ä¸Šä¼ ä¸‹è½½è¿›åº¦ä¸º Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upload-progress
          path: downloads/upload-progress.json
          retention-days: 30
          if-no-files-found: ignore

      - name: ä¸Šä¼ å…ƒæ•°æ®ä¸º Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metadata
          path: |
            downloads/metadata.json
            downloads/metadata-uploaded.json
            downloads/PACKAGES.md
          retention-days: 90
          if-no-files-found: ignore

      - name: ä¿å­˜ apps.json ä¸º Artifactï¼ˆç”¨äºŽä¸‹æ¬¡å¢žé‡æ£€æµ‹ï¼‰
        if: ${{ !inputs.upload_only }}
        uses: actions/upload-artifact@v4
        with:
          name: config-apps-json
          path: config/apps.json
          retention-days: 90
          if-no-files-found: ignore

      - name: æäº¤æ›´æ–°çš„æ–‡ä»¶
        if: ${{ !inputs.download_only && !inputs.upload_only }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # åªæ·»åŠ  downloads ç›®å½•çš„å…ƒæ•°æ®å’Œ README
          # ä¸æäº¤ config/ ç›®å½•ï¼ˆä½¿ç”¨ Artifacts ç®¡ç†ï¼‰
          git add downloads/metadata.json \
                  downloads/metadata-uploaded.json \
                  downloads/PACKAGES.md \
                  downloads/upload-progress.json \
                  2>/dev/null || true

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          else
            # ç»Ÿè®¡æ›´æ–°ä¿¡æ¯
            if [ "${{ steps.check_updates.outputs.has_updates }}" = "true" ]; then
              update_type="å¢žé‡æ›´æ–°: ${{ steps.check_updates.outputs.update_count }} ä¸ªè½¯ä»¶åŒ…"
            else
              update_type="å…ƒæ•°æ®æ›´æ–°"
            fi

            # åˆ›å»ºæäº¤æ¶ˆæ¯
            commit_msg="è‡ªåŠ¨æ›´æ–°: ${update_type}

            ðŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
            ðŸ“… æ›´æ–°æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            ðŸ”— å·¥ä½œæµ: ${{ github.workflow }}
            ðŸ”¢ è¿è¡Œ ID: ${{ github.run_id }}"

            # æ·»åŠ è½¯ä»¶åŒ…æ•°é‡ï¼ˆå¦‚æžœæœ‰ï¼‰
            if [ -f config/apps.json ]; then
              pkg_count=$(jq '.plugins.item | length' config/apps.json)
              commit_msg="${commit_msg}
            ðŸ“¦ è½¯ä»¶åŒ…æ€»æ•°: ${pkg_count}
            â„¹  é…ç½®æ–‡ä»¶å·²ä¿å­˜åˆ° GitHub Actions Artifacts"
            fi

            git commit -m "$commit_msg"

            git push
            echo "âœ“ å·²æäº¤å¹¶æŽ¨é€æ›´æ–°"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆå·¥ä½œæµæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“¦ QNAP è½¯ä»¶åŒ…åŒæ­¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f downloads/metadata.json ]; then
            total=$(jq '. | length' downloads/metadata.json)
            echo "### ä¸‹è½½ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- æ€»æ–‡ä»¶æ•°: $total" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### äº§å“åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "- **\(.productName)** \(.version) (\(.architecture))"' downloads/metadata.json | sort -u >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f downloads/metadata-uploaded.json ]; then
            success=$(jq '[.[] | select(.ctfileUrl != null)] | length' downloads/metadata-uploaded.json)
            failed=$(jq '[.[] | select(.ctfileUrl == null)] | length' downloads/metadata-uploaded.json)

            echo "### ä¸Šä¼ ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æˆåŠŸ: $success" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ å¤±è´¥: $failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ $failed -gt 0 ]; then
              echo "### å¤±è´¥çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | select(.ctfileUrl == null) | "- \(.filename): \(.uploadError // "æœªçŸ¥é”™è¯¯")"' downloads/metadata-uploaded.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
