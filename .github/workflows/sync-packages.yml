name: Sync QNAP Packages

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤© UTC 23:00 (åŒ—äº¬æ—¶é—´ 7:00) è¿è¡Œ
  schedule:
    - cron: '0 23 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      decrypt_config:
        description: 'è§£å¯† config.tar.gz.enc åˆ° config ç›®å½•å¹¶ä¿å­˜åˆ° Cache'
        required: false
        type: boolean
        default: false

# å–æ¶ˆæ­£åœ¨è¿è¡Œçš„æ—§å·¥ä½œæµ
concurrency:
  group: sync-packages
  cancel-in-progress: true

jobs:
  # ä»»åŠ¡1ï¼šè§£å¯†é…ç½®æ–‡ä»¶å¹¶ä¿å­˜åˆ° Cache
  decrypt-config:
    name: è§£å¯†é…ç½®æ–‡ä»¶
    runs-on: ubuntu-latest
    if: ${{ inputs.decrypt_config }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è§£ï¿½ï¿½é…ç½®æ–‡ä»¶
        env:
          ENCRYPTION_PASSWORD: ${{ secrets.ENCRYPTION_PASSWORD }}
        run: |
          echo "ðŸ”“ è§£å¯†é…ç½®æ–‡ä»¶..."

          if [ ! -f "config.tar.gz.enc" ]; then
            echo "âŒ Error: config.tar.gz.enc not found"
            exit 1
          fi

          openssl enc -aes-256-cbc -d -pbkdf2 \
            -in config.tar.gz.enc \
            -out config.tar.gz \
            -pass env:ENCRYPTION_PASSWORD

          tar -xzf config.tar.gz
          rm config.tar.gz

          echo "âœ… Config files restored:"
          ls -lh config/

      - name: ä¿å­˜ config åˆ° Cache
        uses: actions/cache/save@v4
        with:
          path: config/
          key: config-state-${{ github.run_number }}

  # ä»»åŠ¡2ï¼šåŒæ­¥è½¯ä»¶åŒ…
  sync:
    name: åŒæ­¥ QNAP è½¯ä»¶åŒ…
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 å°æ—¶è¶…æ—¶
    needs: [decrypt-config]
    if: always() && (needs.decrypt-config.result == 'success' || needs.decrypt-config.result == 'skipped')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Bun çŽ¯å¢ƒ
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£…ä¾èµ–
        run: bun install --frozen-lockfile

      - name: åˆ›å»ºå¿…è¦çš„ç›®å½•
        run: |
          mkdir -p downloads
          mkdir -p config

      - name: æ¢å¤ config ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: config/
          key: config-state-${{ github.run_number }}
          restore-keys: |
            config-state-

      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶çŠ¶æ€
        run: |
          echo "ðŸ“‹ å½“å‰é…ç½®æ–‡ä»¶ï¼š"
          ls -lh config/ || echo "  config ç›®å½•ä¸ºç©º"
          echo ""

          if [ -f config/upload-progress.json ]; then
            echo "âœ“ æ‰¾åˆ°ä¸Šä¼ è¿›åº¦ç¼“å­˜"
            uploaded_count=$(jq '. | length' config/upload-progress.json)
            echo "  å·²ä¸Šä¼ : $uploaded_count ä¸ªæ–‡ä»¶"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ°ä¸Šä¼ è¿›åº¦ç¼“å­˜ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–ç¼“å­˜è¿‡æœŸï¼‰"
          fi

          if [ -f config/apps.json ]; then
            echo "âœ“ æ‰¾åˆ°è½¯ä»¶åŒ…åˆ—è¡¨ç¼“å­˜"
            apps_count=$(jq '.plugins.item | length' config/apps.json)
            echo "  è½¯ä»¶åŒ…æ€»æ•°: $apps_count"
          fi

          if [ -f config/metadata.json ]; then
            echo "âœ“ æ‰¾åˆ°å…ƒæ•°æ®ç¼“å­˜"
            metadata_count=$(jq '. | length' config/metadata.json)
            echo "  å·²ä¸‹è½½: $metadata_count ä¸ªæ–‡ä»¶"
          fi

      - name: å¯ç”¨ BBR åŠ é€Ÿ
        run: |
          echo "æ­£åœ¨å¯ç”¨ BBR TCP æ‹¥å¡žæŽ§åˆ¶ç®—æ³•..."

          # æ£€æŸ¥å½“å‰å†…æ ¸ç‰ˆæœ¬
          kernel_version=$(uname -r)
          echo "å½“å‰å†…æ ¸ç‰ˆæœ¬: $kernel_version"

          # æ£€æŸ¥ BBR æ¨¡å—æ˜¯å¦å¯ç”¨
          if [ -f /proc/sys/net/ipv4/tcp_available_congestion_control ]; then
            echo "å¯ç”¨çš„æ‹¥å¡žæŽ§åˆ¶ç®—æ³•:"
            cat /proc/sys/net/ipv4/tcp_available_congestion_control
          fi

          # å¯ç”¨ BBR
          sudo sysctl -w net.core.default_qdisc=fq
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr

          # éªŒè¯é…ç½®
          echo ""
          echo "âœ“ BBR é…ç½®å®Œæˆ"
          echo "  é˜Ÿåˆ—è°ƒåº¦ç®—æ³•: $(cat /proc/sys/net/core/default_qdisc)"
          echo "  æ‹¥å¡žæŽ§åˆ¶ç®—æ³•: $(cat /proc/sys/net/ipv4/tcp_congestion_control)"

          # é¢å¤–çš„ç½‘ç»œä¼˜åŒ–å‚æ•°
          sudo sysctl -w net.ipv4.tcp_notsent_lowat=16384
          sudo sysctl -w net.ipv4.tcp_slow_start_after_idle=0

          echo "âœ“ ç½‘ç»œä¼˜åŒ–å‚æ•°å·²åº”ç”¨"

      - name: é…ç½®çŽ¯å¢ƒå˜é‡
        run: |
          cat > .env << EOF
          # QNAP ä¸‹è½½æºé…ç½®
          QNAP_DOWNLOAD_URL=${{ secrets.QNAP_DOWNLOAD_URL }}
          QNAP_USERNAME=${{ secrets.QNAP_USERNAME }}
          QNAP_PASSWORD=${{ secrets.QNAP_PASSWORD }}

          # CTFile é…ç½®
          CTFILE_SESSION=${{ secrets.CTFILE_SESSION }}
          CTFILE_FOLDER_ID=${{ secrets.CTFILE_FOLDER_ID }}
          CTFILE_USER=${{ secrets.CTFILE_USER }}
          CTFILE_PASSWORD=${{ secrets.CTFILE_PASSWORD }}

          # WebDAV é…ç½® (å¯é€‰ï¼Œä½œä¸ºä¸Šä¼ å¤±è´¥çš„å¤‡ç”¨æ–¹æ¡ˆ)
          WEBDAV_URL=${{ secrets.WEBDAV_URL }}
          WEBDAV_USERNAME=${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD=${{ secrets.WEBDAV_PASSWORD }}
          WEBDAV_ROOT_PATH=/qnaporg-github

          # ä¸Šä¼ é…ç½®
          UPLOAD_CONCURRENCY=1
          MAX_UPLOAD_FILE_SIZE=1073741824
          EOF

          echo "âœ“ çŽ¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

      - name: 1. èŽ·å–æœ€æ–°è½¯ä»¶åŒ…åˆ—è¡¨ (fetch)
        run: |
          echo "ðŸ“¥ æ­¥éª¤ 1: èŽ·å–æœ€æ–°çš„ QNAP è½¯ä»¶åŒ…åˆ—è¡¨..."
          bun run fetch

          if [ -f config/apps.json ]; then
            total_count=$(jq '.plugins.item | length' config/apps.json)
            echo "âœ“ è½¯ä»¶åŒ…æ€»æ•°: $total_count"
          fi

      - name: 2. æ£€æŸ¥ä¸Šä¼ çŠ¶æ€ (check-upload)
        run: |
          echo "ðŸ” æ­¥éª¤ 2: æ£€æŸ¥ä¸Šä¼ çŠ¶æ€..."
          bun run check-upload

      - name: 3. æ£€æŸ¥ CTFile å·²å­˜åœ¨æ–‡ä»¶ (check-existing)
        run: |
          echo "ðŸ” æ­¥éª¤ 3: æ£€æŸ¥ CTFile ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶..."
          bun run check-existing

      - name: 4. ä¸‹è½½æ›´æ–°çš„è½¯ä»¶åŒ… (update)
        run: |
          echo "â¬‡ï¸ æ­¥éª¤ 4: ä¸‹è½½æ›´æ–°çš„è½¯ä»¶åŒ…..."
          bun run update

          echo ""
          echo "ðŸ“Š ä¸‹è½½ç»Ÿè®¡ï¼š"
          if [ -f config/metadata.json ]; then
            echo "  å…ƒæ•°æ®æ–‡ä»¶: âœ“"
            total=$(jq '. | length' config/metadata.json)
            echo "  æ€»è®¡: $total ä¸ªè½¯ä»¶åŒ…"
          else
            echo "  âš  æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
          fi

          echo ""
          echo "ðŸ’¾ ä¸‹è½½æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh downloads/*.qpkg 2>/dev/null | awk '{print "  " $9 " (" $5 ")"}' || echo "  æœªæ‰¾åˆ° QPKG æ–‡ä»¶"

      - name: 5. ä¸Šä¼ åˆ° CTFile (upload)
        run: |
          echo "â¬†ï¸ æ­¥éª¤ 5: ä¸Šä¼ åˆ° CTFile..."

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ 
          if ! ls downloads/*.qpkg 1> /dev/null 2>&1; then
            echo "âš  æ²¡æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ "
          else
            bun run upload
          fi

          echo ""
          echo "ðŸ“Š ä¸Šä¼ ç»“æžœï¼š"
          if [ -f config/metadata-uploaded.json ]; then
            echo "  ä¸Šä¼ å…ƒæ•°æ®: âœ“"

            # ç»Ÿè®¡ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶
            success=$(jq '[.[] | select(.ctfileUrl != null)] | length' config/metadata-uploaded.json)
            total=$(jq '. | length' config/metadata-uploaded.json)
            echo "  æˆåŠŸ: $success/$total"
          fi

      - name: ç”Ÿæˆå·¥ä½œæµæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“¦ QNAP è½¯ä»¶åŒ…åŒæ­¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f config/metadata.json ]; then
            total=$(jq '. | length' config/metadata.json)
            echo "### ä¸‹è½½ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- æ€»æ–‡ä»¶æ•°: $total" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### äº§å“åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "- **\(.productName)** \(.version) (\(.architecture))"' config/metadata.json | sort -u >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f config/metadata-uploaded.json ]; then
            success=$(jq '[.[] | select(.ctfileUrl != null)] | length' config/metadata-uploaded.json)
            failed=$(jq '[.[] | select(.ctfileUrl == null)] | length' config/metadata-uploaded.json)

            echo "### ä¸Šä¼ ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æˆåŠŸ: $success" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ å¤±è´¥: $failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ $failed -gt 0 ]; then
              echo "### å¤±è´¥çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | select(.ctfileUrl == null) | "- \(.filename): \(.uploadError // "æœªçŸ¥é”™è¯¯")"' config/metadata-uploaded.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
